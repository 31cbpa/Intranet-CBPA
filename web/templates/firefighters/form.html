{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{{ title }}</h1>
    <a href="{% url 'firefighter_list' %}" class="btn btn-secondary">Cancelar</a>
</div>

<form method="post">
    {% csrf_token %}
    
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">Información institucional</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.company.id_for_label }}" class="form-label">{{ form.company.label }}*</label>
                    {{ form.company }}
                    {% if form.company.errors %}
                        <div class="text-danger">{{ form.company.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.registration_number.id_for_label }}" class="form-label">{{ form.registration_number.label }}*</label>
                    {{ form.registration_number }}
                    {% if form.registration_number.errors %}
                        <div class="text-danger">{{ form.registration_number.errors }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="{{ form.entry_date.id_for_label }}" class="form-label">{{ form.entry_date.label }}*</label>
                    {{ form.entry_date }}
                    {% if form.entry_date.errors %}
                        <div class="text-danger">{{ form.entry_date.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.quality.id_for_label }}" class="form-label">{{ form.quality.label }}*</label>
                    {{ form.quality }}
                    {% if form.quality.errors %}
                        <div class="text-danger">{{ form.quality.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.position.id_for_label }}" class="form-label">{{ form.position.label }}*</label>
                    {{ form.position }}
                    {% if form.position.errors %}
                        <div class="text-danger">{{ form.position.errors }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.email.id_for_label }}" class="form-label">{{ form.email.label }}*</label>
                    {{ form.email }}
                    {% if form.email.errors %}
                        <div class="text-danger">{{ form.email.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="card-title mb-0">Información personal</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="{{ form.first_name.id_for_label }}" class="form-label">{{ form.first_name.label }}*</label>
                    {{ form.first_name }}
                    {% if form.first_name.errors %}
                        <div class="text-danger">{{ form.first_name.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.paternal_surname.id_for_label }}" class="form-label">{{ form.paternal_surname.label }}*</label>
                    {{ form.paternal_surname }}
                    {% if form.paternal_surname.errors %}
                        <div class="text-danger">{{ form.paternal_surname.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.maternal_surname.id_for_label }}" class="form-label">{{ form.maternal_surname.label }}*</label>
                    {{ form.maternal_surname }}
                    {% if form.maternal_surname.errors %}
                        <div class="text-danger">{{ form.maternal_surname.errors }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="{{ form.rut.id_for_label }}" class="form-label">{{ form.rut.label }}</label>
                    {{ form.rut }}
                    {% if form.rut.errors %}
                        <div class="text-danger">{{ form.rut.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.birth_date.id_for_label }}" class="form-label">{{ form.birth_date.label }}</label>
                    {{ form.birth_date }}
                    {% if form.birth_date.errors %}
                        <div class="text-danger">{{ form.birth_date.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.gender.id_for_label }}" class="form-label">{{ form.gender.label }}</label>
                    {% if form.gender.errors %}
                        <div class="text-danger">{{ form.gender.errors }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.address.id_for_label }}" class="form-label">{{ form.address.label }}</label>
                    {{ form.address }}
                    {% if form.address.errors %}
                        <div class="text-danger">{{ form.address.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.commune.id_for_label }}" class="form-label">{{ form.commune.label }}</label>
                    {{ form.commune }}
                    {% if form.commune.errors %}
                        <div class="text-danger">{{ form.commune.errors }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.contact_number.id_for_label }}" class="form-label">{{ form.contact_number.label }}</label>
                    {{ form.contact_number }}
                    {% if form.contact_number.errors %}
                        <div class="text-danger">{{ form.contact_number.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.personal_email.id_for_label }}" class="form-label">{{ form.personal_email.label }}</label>
                    {{ form.personal_email }}
                    {% if form.personal_email.errors %}
                        <div class="text-danger">{{ form.personal_email.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Contactos de emergencia</h5>
            <button type="button" class="btn btn-light" id="add-contact">Agregar contacto</button>
        </div>
        <div class="card-body">
            {{ formset.management_form }}
            
            <div id="emergency-contacts">
                {% for contact_form in formset %}
                <div class="contact-form mb-4">
                    {% if contact_form.instance.pk %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6>Contacto de emergencia</h6>
                        {{ contact_form.DELETE.label_tag }}
                        {{ contact_form.DELETE }}
                    </div>
                    {% endif %}
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="{{ contact_form.first_name.id_for_label }}" class="form-label">Nombre*</label>
                            {{ contact_form.first_name }}
                            {% if contact_form.first_name.errors %}
                                <div class="text-danger">{{ contact_form.first_name.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ contact_form.paternal_surname.id_for_label }}" class="form-label">Apellido paterno*</label>
                            {{ contact_form.paternal_surname }}
                            {% if contact_form.paternal_surname.errors %}
                                <div class="text-danger">{{ contact_form.paternal_surname.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ contact_form.maternal_surname.id_for_label }}" class="form-label">Apellido materno*</label>
                            {{ contact_form.maternal_surname }}
                            {% if contact_form.maternal_surname.errors %}
                                <div class="text-danger">{{ contact_form.maternal_surname.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ contact_form.relationship.id_for_label }}" class="form-label">Parentesco*</label>
                            {{ contact_form.relationship }}
                            {% if contact_form.relationship.errors %}
                                <div class="text-danger">{{ contact_form.relationship.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ contact_form.contact_number.id_for_label }}" class="form-label">Número de contacto*</label>
                            {{ contact_form.contact_number }}
                            {% if contact_form.contact_number.errors %}
                                <div class="text-danger">{{ contact_form.contact_number.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    {{ contact_form.id }}
                    <hr>
                </div>
                {% endfor %}
            </div>
            
            <div id="empty-form" class="d-none">
                <div class="contact-form mb-4">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Nombre*</label>
                            {{ formset.empty_form.first_name }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Apellido paterno*</label>
                            {{ formset.empty_form.paternal_surname }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Apellido materno*</label>
                            {{ formset.empty_form.maternal_surname }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Parentesco*</label>
                            {{ formset.empty_form.relationship }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Número de contacto*</label>
                            {{ formset.empty_form.contact_number }}
                        </div>
                    </div>
                    {{ formset.empty_form.id }}
                    <hr>
                </div>
            </div>
        </div>
    </div>
    
    <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
        <button type="submit" class="btn btn-primary btn-lg">Guardar</button>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
    // Aplicar clases de Bootstrap a los formularios
    document.addEventListener('DOMContentLoaded', function() {
        const formInputs = document.querySelectorAll('input, select, textarea');
        formInputs.forEach(input => {
            if (input.type !== 'checkbox') {
                input.classList.add('form-control');
            }
        });
        
        // Manejo de formsets para contactos de emergencia
        const addContactBtn = document.getElementById('add-contact');
        const totalForms = document.getElementById('id_emergency_contacts-TOTAL_FORMS');
        const formsetContainer = document.getElementById('emergency-contacts');
        const emptyForm = document.getElementById('empty-form').innerHTML;
        
        addContactBtn.addEventListener('click', function() {
            const formCount = parseInt(totalForms.value);
            const newForm = emptyForm.replace(/__prefix__/g, formCount);
            formsetContainer.insertAdjacentHTML('beforeend', newForm);
            totalForms.value = formCount + 1;
            
            // Aplicar clases a los nuevos elementos
            const newInputs = formsetContainer.querySelectorAll(`[id^=id_emergency_contacts-${formCount}]`);
            newInputs.forEach(input => {
                if (input.type !== 'checkbox') {
                    input.classList.add('form-control');
                }
            });
        });
    });
</script>
{% endblock %}
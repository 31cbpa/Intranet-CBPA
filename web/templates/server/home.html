{% extends 'layout/base.html' %}
{% load static %}

{% block page_title %}Panel de Administración del Servidor{% endblock %}

{% block main_content %}
<div class="row">
    <div class="col-12 mg-top-30">
        <div class="crancy-pbreadcrumb">
            <h2>Panel de Administración del Servidor</h2>
        </div>
    </div>
</div>

<!-- Dashboard Principal -->
<div class="row mt-4">
    <div class="col-12">
        <div class="crancy-card">
            <div class="crancy-card-header">
                <h4 class="crancy-card-title">Estado General del Sistema</h4>
            </div>
            <div class="crancy-card-body">
                <div class="row">
                    <!-- Estado del servidor -->
                    <div class="col-md-3">
                        <div class="crancy-history crancy-history--ticket h-100 bg-success-soft">
                            <div class="crancy-history__main">
                                <div class="crancy-history__content mb-0">
                                    <h4 class="crancy-history__number ms-3">
                                        Online
                                        <span>Estado del Servidor</span>
                                    </h4>
                                    <div class="crancy-history__icon crancy-color1__opacity--bg me-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" viewBox="0 0 24 24">
                                            <path fill="currentColor" d="M21 14c0-.55-.45-1-1-1h-2v2h2c.55 0 1-.45 1-1m-1 3h-2v2h2c.55 0 1-.45 1-1s-.45-1-1-1m-8-3h-2v4h2c0 1.1.9 2 2 2h3v-8h-3c-1.1 0-2 .9-2 2M5 13c0-1.1.9-2 2-2h1.5c1.93 0 3.5-1.57 3.5-3.5S10.43 4 8.5 4H5c-.55 0-1 .45-1 1s.45 1 1 1h3.5c.83 0 1.5.67 1.5 1.5S9.33 9 8.5 9H7c-2.21 0-4 1.79-4 4s1.79 4 4 4h2v-2H7c-1.1 0-2-.9-2-2"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CPU -->
                    <div class="col-md-3">
                        <div class="crancy-history crancy-history--ticket h-100">
                            <div class="crancy-history__main">
                                <div class="crancy-history__content mb-0">
                                    <h4 class="crancy-history__number ms-3">
                                        {{ cpu_usage }}%
                                        <span>Uso de CPU</span>
                                    </h4>
                                    <div class="crancy-history__icon {% if cpu_usage > 80 %}crancy-color3__opacity--bg{% elif cpu_usage > 50 %}crancy-color2__opacity--bg{% else %}crancy-color1__opacity--bg{% endif %} me-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" viewBox="0 0 24 24">
                                            <path fill="currentColor" d="M15 9H9v6h6zm-2 4h-2v-2h2zm8-2V9h-2V7c0-1.1-.9-2-2-2h-2V3h-2v2h-2V3H9v2H7c-1.1 0-2 .9-2 2v2H3v2h2v2H3v2h2v2c0 1.1.9 2 2 2h2v2h2v-2h2v2h2v-2h2c1.1 0 2-.9 2-2v-2h2v-2h-2v-2zm-4 6H7V7h10z"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Memoria -->
                    <div class="col-md-3">
                        <div class="crancy-history crancy-history--ticket h-100">
                            <div class="crancy-history__main">
                                <div class="crancy-history__content mb-0">
                                    <h4 class="crancy-history__number ms-3">
                                        {{ memory_percent }}%
                                        <span>Uso de Memoria</span>
                                    </h4>
                                    <div class="crancy-history__icon {% if memory_percent > 80 %}crancy-color3__opacity--bg{% elif memory_percent > 50 %}crancy-color2__opacity--bg{% else %}crancy-color1__opacity--bg{% endif %} me-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" viewBox="0 0 24 24">
                                            <path fill="currentColor" d="M17 17H7V7h10m0 13H7a3 3 0 0 1-3-3V7a3 3 0 0 1 3-3h10a3 3 0 0 1 3 3v10a3 3 0 0 1-3 3M15 9h-2V8h-2v1H9v2h4v1h-2.03v.03H9V14h2v1h2v-1h2v-2h-4v-1h2z"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tiempo de actividad -->
                    <div class="col-md-3">
                        <div class="crancy-history crancy-history--ticket h-100">
                            <div class="crancy-history__main">
                                <div class="crancy-history__content mb-0">
                                    <h4 class="crancy-history__number ms-3">
                                        <span id="uptime-counter">Calculando...</span>
                                        <span>Tiempo activo</span>
                                    </h4>
                                    <div class="crancy-history__icon crancy-color4__opacity--bg me-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" viewBox="0 0 24 24">
                                            <path fill="currentColor" d="M12 20a8 8 0 0 0 8-8a8 8 0 0 0-8-8a8 8 0 0 0-8 8a8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10a10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67l-.75 1.23L11 13V7z"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <!-- Gráfico del Uso de CPU -->
                    <div class="col-md-6">
                        <div class="chart-container">
                            <canvas id="cpuChart" height="200"></canvas>
                        </div>
                    </div>
                    
                    <!-- Gráfico del Uso de Memoria -->
                    <div class="col-md-6">
                        <div class="chart-container">
                            <canvas id="memoryChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Estado del proyecto -->
<div class="row mt-4">
    <div class="col-12">
        <div class="crancy-card">
            <div class="crancy-card-header">
                <h4 class="crancy-card-title">Entorno Actual</h4>
            </div>
            <div class="crancy-card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h3 class="mb-0">
                            {% if is_debug %}
                            <span class="badge bg-primary p-2 ms-2">DEBUG</span>
                            {% endif %}
                            <span class="badge {% if environment == 'production' %}bg-success{% else %}bg-primary{% endif %} p-2">
                                {{ environment|title }}
                            </span>
                        </h3>
                        <p class="text-muted mt-2">
                            Base de datos actual: <strong>{{ db_current }}</strong> ({{ db_name }})
                        </p>
                    </div>
                    <div>
                        <p class="mb-0"><strong>Modo de ejecución:</strong> 
                            {% if environment == 'production' %}
                            Producción
                            {% else %}
                            Desarrollo
                            {% endif %}
                        </p>
                        <p class="mb-0"><strong>Estado del depurador:</strong> 
                            {% if is_debug %}
                            Activado
                            {% else %}
                            Desactivado
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Información del Sistema -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="crancy-card">
            <div class="crancy-card-header">
                <h4 class="crancy-card-title">Información del Sistema</h4>
            </div>
            <div class="crancy-card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <tbody>
                            <tr>
                                <td width="40%"><strong>Hostname</strong></td>
                                <td>{{ hostname }}</td>
                            </tr>
                            <tr>
                                <td><strong>Sistema Operativo</strong></td>
                                <td>{{ os }} {{ os_version }}</td>
                            </tr>
                            <tr>
                                <td><strong>Plataforma</strong></td>
                                <td>{{ platform }}</td>
                            </tr>
                            <tr>
                                <td><strong>Procesador</strong></td>
                                <td>{{ cpu_cores }} núcleos</td>
                            </tr>
                            <tr>
                                <td><strong>Hora de inicio</strong></td>
                                <td>{{ boot_time }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="crancy-card">
            <div class="crancy-card-header">
                <h4 class="crancy-card-title">Uso de Recursos</h4>
            </div>
            <div class="crancy-card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <tbody>
                            <tr>
                                <td width="40%"><strong>Memoria Total</strong></td>
                                <td>{{ total_memory }} GB</td>
                            </tr>
                            <tr>
                                <td><strong>Memoria Usada</strong></td>
                                <td>{{ used_memory }} GB ({{ memory_percent }}%)</td>
                            </tr>
                            <tr>
                                <td><strong>Memoria Disponible</strong></td>
                                <td>{{ free_memory }} GB</td>
                            </tr>
                            <tr>
                                <td><strong>Uso de CPU</strong></td>
                                <td>
                                    <div class="progress">
                                        <div class="progress-bar {% if cpu_usage > 80 %}bg-danger{% elif cpu_usage > 50 %}bg-warning{% else %}bg-success{% endif %}" 
                                             role="progressbar" 
                                             style="width: '{{ cpu_usage|default_if_none:0 }}%'"
                                             aria-valuenow="{{ cpu_usage }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                            {{ cpu_usage }}%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Uso de Memoria</strong></td>
                                <td>
                                    <div class="progress">
                                        <div class="progress-bar {% if memory_percent > 80 %}bg-danger{% elif memory_percent > 50 %}bg-warning{% else %}bg-success{% endif %}" 
                                             role="progressbar"
                                             style="width: '{{ memory_percent|default_if_none:0 }}%'"
                                             aria-valuenow="{{ memory_percent }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                            {{ memory_percent }}%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Especificaciones Técnicas -->
<div class="row mt-4">
    <div class="col-12">
        <div class="crancy-card">
            <div class="crancy-card-header">
                <h4 class="crancy-card-title">Especificaciones Técnicas</h4>
            </div>
            <div class="crancy-card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="mb-3">Entorno de Desarrollo</h5>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <tbody>
                                    <tr>
                                        <td width="40%"><strong>Versión de Python</strong></td>
                                        <td>{{ python_version }}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Versión de Django</strong></td>
                                        <td>{{ django_version }}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Base de Datos (Desarrollo)</strong></td>
                                        <td>{{ db_dev }}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Base de Datos (Producción)</strong></td>
                                        <td>{{ db_prod }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5 class="mb-3">Estado de Servicios</h5>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <tbody>
                                    <tr>
                                        <td width="40%"><strong>Estado del Servidor</strong></td>
                                        <td>
                                            <span class="badge bg-success">Activo</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Base de Datos</strong></td>
                                        <td id="db-status">
                                            <span class="badge bg-secondary">Verificando...</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Dirección IP</strong></td>
                                        <td>{{ ip_address }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CSS personalizado -->
<style>
    .chart-container {
        position: relative;
        margin: auto;
        height: 200px;
    }
    
    .progress {
        height: 20px;
        border-radius: 5px;
    }
    
    .progress-bar {
        line-height: 20px;
        font-size: 12px;
    }
    
    .bg-success-soft {
        background-color: rgba(46, 204, 113, 0.2);
    }
    
    .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }
    
    .bg-success {
        background-color: #2ecc71 !important;
    }
    
    .bg-warning {
        background-color: #f39c12 !important;
    }
    
    .bg-danger {
        background-color: #e74c3c !important;
    }
</style>

<!-- JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Variables globales
        const bootTime = new Date("{{ boot_time }}");
        
        // Calcular y mostrar tiempo de actividad
        updateUptimeCounter();
        setInterval(updateUptimeCounter, 1000);
        
        // Inicializar gráficos
        initCharts();
        
        // Cargar datos adicionales
        loadServerStatus();
        checkDatabaseStatus();
        
        // Actualizar datos periódicamente cada 30 segundos
        setInterval(loadServerStatus, 30000);
        
        // Funciones de utilidad
        function updateUptimeCounter() {
            const now = new Date();
            const diff = now - bootTime;
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            document.getElementById('uptime-counter').textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
        }
        
        function initCharts() {
            // Crear gráfico de CPU
            const cpuCtx = document.getElementById('cpuChart').getContext('2d');
            const cpuChart = new Chart(cpuCtx, {
                type: 'line',
                data: {
                    labels: Array(30).fill('').map((_, i) => `-${30-i} sec`),
                    datasets: [{
                        label: 'Uso de CPU (%)',
                        data: Array(30).fill("{{ cpu_usage }}"),
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 2,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Uso de CPU en tiempo real'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Porcentaje de uso'
                            }
                        }
                    }
                }
            });
            
            // Guardar referencia al gráfico
            window.cpuChart = cpuChart;
            
            // Crear gráfico de memoria
            const memoryCtx = document.getElementById('memoryChart').getContext('2d');
            const memoryChart = new Chart(memoryCtx, {
                type: 'line',
                data: {
                    labels: Array(30).fill('').map((_, i) => `-${30-i} sec`),
                    datasets: [{
                        label: 'Uso de Memoria (%)',
                        data: Array(30).fill("{{ memory_percent }}"),
                        backgroundColor: 'rgba(46, 204, 113, 0.2)',
                        borderColor: 'rgba(46, 204, 113, 1)',
                        borderWidth: 2,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Uso de Memoria en tiempo real'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Porcentaje de uso'
                            }
                        }
                    }
                }
            });
            
            // Guardar referencia al gráfico
            window.memoryChart = memoryChart;
        }
        
        function loadServerStatus() {
            // Obtener datos de estado en tiempo real
            fetch('/server-api/status/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor');
                    }
                    return response.json();
                })
                .then(data => {
                    // Actualizar gráfico de CPU
                    window.cpuChart.data.datasets[0].data.shift();
                    window.cpuChart.data.datasets[0].data.push(data.cpu_usage);
                    window.cpuChart.update();
                    
                    // Actualizar gráfico de memoria
                    window.memoryChart.data.datasets[0].data.shift();
                    window.memoryChart.data.datasets[0].data.push(data.memory_percent);
                    window.memoryChart.update();
                    
                    // Actualizar elementos de la UI
                    updateUIElements(data);
                })
                .catch(error => {
                    console.error('Error cargando datos del servidor:', error);
                });
        }
        
        function checkDatabaseStatus() {
            // Verificar el estado de la base de datos
            fetch('/server-api/db-info/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor');
                    }
                    return response.json();
                })
                .then(data => {
                    const statusElement = document.getElementById('db-status');
                    
                    if (data.status === 'online') {
                        let dbInfo = '';
                        if (data.database && data.database.version) {
                            dbInfo = `<span class="badge bg-success">Conectado</span> ${data.database.version}`;
                        } else {
                            dbInfo = '<span class="badge bg-success">Conectado</span>';
                        }
                        statusElement.innerHTML = dbInfo;
                    } else {
                        statusElement.innerHTML = '<span class="badge bg-danger">Error de conexión</span>';
                    }
                })
                .catch(error => {
                    console.error('Error verificando estado de la base de datos:', error);
                    const statusElement = document.getElementById('db-status');
                    statusElement.innerHTML = '<span class="badge bg-danger">Error de conexión</span>';
                });
        }
        
        function updateUIElements(data) {
            // Actualizar valores de CPU y memoria
            const cpuElements = document.querySelectorAll('.crancy-history__number:contains("Uso de CPU")');
            cpuElements.forEach(element => {
                element.innerHTML = `${data.cpu_usage}%<span>Uso de CPU</span>`;
            });
            
            const memoryElements = document.querySelectorAll('.crancy-history__number:contains("Uso de Memoria")');
            memoryElements.forEach(element => {
                element.innerHTML = `${data.memory_percent}%<span>Uso de Memoria</span>`;
            });
            
            // Actualizar barras de progreso
            const cpuBars = document.querySelectorAll('.progress-bar[aria-valuenow="{{ cpu_usage }}"]');
            cpuBars.forEach(bar => {
                bar.style.width = `${data.cpu_usage}%`;
                bar.textContent = `${data.cpu_usage}%`;
                bar.setAttribute('aria-valuenow', data.cpu_usage);
                
                // Actualizar clase según valor
                if (data.cpu_usage > 80) {
                    bar.className = 'progress-bar bg-danger';
                } else if (data.cpu_usage > 50) {
                    bar.className = 'progress-bar bg-warning';
                } else {
                    bar.className = 'progress-bar bg-success';
                }
            });
            
            // Actualizar barras de progreso de memoria
            const memoryBars = document.querySelectorAll('.progress-bar[aria-valuenow="{{ memory_percent }}"]');
            memoryBars.forEach(bar => {
                bar.style.width = `${data.memory_percent}%`;
                bar.textContent = `${data.memory_percent}%`;
                bar.setAttribute('aria-valuenow', data.memory_percent);
                
                // Actualizar clase según valor
                if (data.memory_percent > 80) {
                    bar.className = 'progress-bar bg-danger';
                } else if (data.memory_percent > 50) {
                    bar.className = 'progress-bar bg-warning';
                } else {
                    bar.className = 'progress-bar bg-success';
                }
            });
            
            // Actualizar valores en la tabla de recursos
            const memoryUsedElement = document.querySelector('td:contains("Memoria Usada")').nextElementSibling;
            if (memoryUsedElement) {
                memoryUsedElement.textContent = `${data.memory_used} GB (${data.memory_percent}%)`;
            }
            
            const memoryFreeElement = document.querySelector('td:contains("Memoria Disponible")').nextElementSibling;
            if (memoryFreeElement) {
                memoryFreeElement.textContent = `${data.memory_free} GB`;
            }
        }
        
        // Extensión de QuerySelector para encontrar elementos por texto contenido
        // (Polyfill para el selector :contains que no es estándar)
        document.querySelectorAll = document.querySelectorAll || function(selector) {
            if (selector.includes(':contains(')) {
                const searchText = selector.match(/:contains\("?([^"]*)"?\)/)[1];
                selector = selector.replace(/:contains\("?[^"]*"?\)/, '');
                
                const elements = Array.from(document.querySelectorAll(selector || '*'));
                return elements.filter(el => el.textContent.includes(searchText));
            } else {
                return document.querySelectorAll(selector);
            }
        };
    });
</script>
{% endblock main_content %}